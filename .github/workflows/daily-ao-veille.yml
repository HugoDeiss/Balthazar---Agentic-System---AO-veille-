name: AO Veille Quotidienne

on:
  schedule:
    # Tous les jours Ã  6h00 UTC (7h Paris hiver, 8h Paris Ã©tÃ©)
    - cron: '0 6 * * *'
  
  # Permet de dÃ©clencher manuellement le workflow pour tester
  workflow_dispatch:
    inputs:
      since:
        description: 'Date de dÃ©but (YYYY-MM-DD) - laissez vide pour hier'
        required: false
        type: string
      until:
        description: 'Date de fin (YYYY-MM-DD) - optionnel, pour plage (ex: 21/01 au 03/02)'
        required: false
        type: string
      clientId:
        description: 'ID du client (laissez vide pour utiliser le dÃ©faut)'
        required: false
        type: string

jobs:
  run-ao-veille:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“… Calculer la date de recherche
        id: date
        run: |
          if [ -n "${{ github.event.inputs.since }}" ]; then
            echo "since=${{ github.event.inputs.since }}" >> $GITHUB_OUTPUT
          else
            echo "since=$(date -d '1 day ago' '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi
          if [ -n "${{ github.event.inputs.until }}" ]; then
            echo "until=${{ github.event.inputs.until }}" >> $GITHUB_OUTPUT
          else
            echo "until=" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¡ DÃ©terminer activation MarchesOnline
        id: marchesonline
        run: |
          DAY_OF_WEEK=$(date +%u)  # 1=lundi, 3=mercredi, 5=vendredi, 7=dimanche
          
          if [ "$DAY_OF_WEEK" -eq 3 ] || [ "$DAY_OF_WEEK" -eq 5 ]; then
            echo "ğŸ“¡ MarchesOnline activÃ© (mercredi ou vendredi)"
            echo 'urls=["https://www.marchesonline.com/mol/rss/appels-d-offres-domaine-activite-services.xml"]' >> $GITHUB_OUTPUT
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¡ MarchesOnline dÃ©sactivÃ©"
            echo 'urls=[]' >> $GITHUB_OUTPUT
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸš€ DÃ©clencher le workflow AO Veille
        id: trigger
        run: |
          # GitHub Actions = orchestration uniquement :
          # on dÃ©clenche le workflow Mastra et on vÃ©rifie le code HTTP.
          # Ne pas stocker de gros JSON dans les outputs (risque de dÃ©passement mÃ©moire cÃ´tÃ© expressions GitHub).
          RUN_ID="gh-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          CLIENT_ID="${{ github.event.inputs.clientId }}"
          if [ -z "$CLIENT_ID" ]; then
            CLIENT_ID="${{ secrets.BALTHAZAR_CLIENT_ID }}"
          fi
          
          echo "ğŸ”— GitHub Run ID: $RUN_ID"
          echo "ğŸ” Lancement de la veille pour le client: $CLIENT_ID"
          echo "ğŸ“… Depuis: ${{ steps.date.outputs.since }}"
          echo "ğŸ“… Jusqu'Ã : ${{ steps.date.outputs.until }}"
          echo "ğŸ“¡ MarchesOnline: ${{ steps.marchesonline.outputs.enabled }}"
          echo ""
          
          # Health check optionnel de Mastra Cloud
          echo "ğŸ¥ VÃ©rification de la disponibilitÃ© de Mastra Cloud..."
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 ${{ secrets.MASTRA_CLOUD_URL }} || echo "000")
          
          if [ "$HEALTH_CHECK" = "000" ]; then
            echo "âš ï¸  Mastra Cloud ne rÃ©pond pas (timeout)"
          elif [ "$HEALTH_CHECK" = "200" ] || [ "$HEALTH_CHECK" = "404" ]; then
            echo "âœ… Mastra Cloud est accessible (code $HEALTH_CHECK)"
          else
            echo "âš ï¸  Mastra Cloud rÃ©pond avec le code $HEALTH_CHECK"
          fi
          echo ""
          
          # Construire le JSON de maniÃ¨re sÃ©curisÃ©e avec jq
          echo "ğŸ“¦ Construction du payload JSON..."
          PAYLOAD=$(jq -n \
            --arg clientId "$CLIENT_ID" \
            --arg since "${{ steps.date.outputs.since }}" \
            --arg until "${{ steps.date.outputs.until }}" \
            --argjson urls '${{ steps.marchesonline.outputs.urls }}' \
            '{
              inputData: {
                clientId: $clientId,
                since: $since,
                marchesonlineRSSUrls: $urls
              } + (if $until != "" then {until: $until} else {} end)
            }')
          
          echo "ğŸ“¦ Payload construit (compact):"
          echo "$PAYLOAD" | jq -c '.'
          
          # Valider que le JSON est bien formÃ©
          if ! echo "$PAYLOAD" | jq empty 2>/dev/null; then
            echo "âŒ ERREUR CRITIQUE: Le payload JSON est invalide"
            echo "$PAYLOAD"
            exit 1
          fi
          echo "âœ… Payload JSON validÃ©"
          echo ""
          
          # Retry logic pour gÃ©rer les erreurs transitoires
          MAX_RETRIES=3
          RETRY_DELAY=10  # secondes
          SUCCESS=false
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ”„ Tentative $attempt/$MAX_RETRIES..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Run-Id: $RUN_ID" \
              -d "$PAYLOAD" \
              ${{ secrets.MASTRA_CLOUD_URL }}/api/workflows/aoVeilleWorkflow/start-async)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "ğŸ“Š Code HTTP: $HTTP_CODE"
            
            # Si succÃ¨s (2xx) ou erreur client (4xx), on arrÃªte
            if [[ "$HTTP_CODE" =~ ^2 ]]; then
              echo "âœ… SuccÃ¨s (code $HTTP_CODE)"
              SUCCESS=true
              break
            elif [[ "$HTTP_CODE" =~ ^4 ]]; then
              echo "âŒ Erreur client (code $HTTP_CODE) - Pas de retry"
              break
            fi
            
            # Si erreur serveur (5xx) et pas la derniÃ¨re tentative, on retry
            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "âš ï¸  Erreur serveur (code $HTTP_CODE), retry dans ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            else
              echo "âŒ Ã‰chec aprÃ¨s $MAX_RETRIES tentatives"
            fi
          done
          
          # VÃ©rifier le succÃ¨s final
          if [ "$SUCCESS" != "true" ] && [[ ! "$HTTP_CODE" =~ ^2 ]]; then
            echo "âŒ Le workflow n'a pas pu Ãªtre dÃ©clenchÃ©"
          fi
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RÃ©sultat Final"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”— GitHub Run ID: $RUN_ID"
          echo "ğŸ“Š Code HTTP: $HTTP_CODE"
          echo "ğŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Preview tronquÃ© de la rÃ©ponse
          MAX_PREVIEW_CHARS=4000
          BODY_PREVIEW="$BODY"
          if [ ${#BODY_PREVIEW} -gt $MAX_PREVIEW_CHARS ]; then
            BODY_PREVIEW="${BODY_PREVIEW:0:$MAX_PREVIEW_CHARS}...[truncated]"
          fi
          echo "ğŸ“¦ RÃ©ponse (preview):"
          echo "$BODY_PREVIEW"
          
          # Si erreur, afficher le payload pour debug
          if [[ ! "$HTTP_CODE" =~ ^2 ]]; then
            echo ""
            echo "âš ï¸  PAYLOAD ENVOYÃ‰ (pour debug):"
            echo "$PAYLOAD" | jq '.'
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âœ… VÃ©rifier le succÃ¨s
        if: ${{ startsWith(steps.trigger.outputs.http_code, '2') }}
        run: |
          echo "âœ… Workflow exÃ©cutÃ© avec succÃ¨s (code HTTP 2xx)."
          echo "â„¹ï¸  Voir les logs de l'Ã©tape 'ğŸš€ DÃ©clencher le workflow AO Veille' pour le dÃ©tail de la rÃ©ponse Mastra."
      
      - name: âŒ GÃ©rer l'Ã©chec
        if: ${{ !startsWith(steps.trigger.outputs.http_code, '2') }}
        run: |
          echo "âŒ Le workflow a Ã©chouÃ© avec le code HTTP: ${{ steps.trigger.outputs.http_code }}"
          echo ""
          echo "ğŸ” Actions de debug recommandÃ©es:"
          echo "1. VÃ©rifier les logs de l'Ã©tape 'ğŸš€ DÃ©clencher le workflow AO Veille'"
          echo "2. VÃ©rifier le payload JSON envoyÃ© (affichÃ© dans les logs si erreur)"
          echo "3. VÃ©rifier les logs Mastra Cloud pour le GitHub Run ID"
          echo "4. Tester manuellement avec curl (voir GITHUB_WORKFLOW_QUOTIDIEN.md)"
          echo ""
          echo "ğŸ“š Documentation: GITHUB_WORKFLOW_QUOTIDIEN.md"
          exit 1
      
      - name: ğŸ“§ Notifier en cas d'Ã©chec
        if: failure()
        run: |
          echo "âš ï¸ ATTENTION: Le workflow AO Veille a Ã©chouÃ© !"
          echo "VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails."
          # TODO: Ajouter une notification email/Slack ici si nÃ©cessaire

