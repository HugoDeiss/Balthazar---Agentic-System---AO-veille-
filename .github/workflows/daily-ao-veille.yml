name: AO Veille Quotidienne

on:
  schedule:
    # Tous les jours √† 6h00 UTC (7h Paris hiver, 8h Paris √©t√©)
    - cron: '0 6 * * *'
  
  # Permet de d√©clencher manuellement le workflow pour tester
  workflow_dispatch:
    inputs:
      since:
        description: 'Date de d√©but (YYYY-MM-DD) - laissez vide pour hier'
        required: false
        type: string
      until:
        description: 'Date de fin (YYYY-MM-DD) - optionnel, pour plage (ex: 21/01 au 03/02)'
        required: false
        type: string
      clientId:
        description: 'ID du client (laissez vide pour utiliser le d√©faut)'
        required: false
        type: string

jobs:
  run-ao-veille:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìÖ Calculer la date de recherche
        id: date
        run: |
          if [ -n "${{ github.event.inputs.since }}" ]; then
            echo "since=${{ github.event.inputs.since }}" >> $GITHUB_OUTPUT
          else
            echo "since=$(date -d '1 day ago' '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi
          if [ -n "${{ github.event.inputs.until }}" ]; then
            echo "until=${{ github.event.inputs.until }}" >> $GITHUB_OUTPUT
          else
            echo "until=" >> $GITHUB_OUTPUT
          fi
      
      - name: üì° D√©terminer activation MarchesOnline
        id: marchesonline
        run: |
          DAY_OF_WEEK=$(date +%u)  # 1=lundi, 3=mercredi, 5=vendredi, 7=dimanche
          
          if [ "$DAY_OF_WEEK" -eq 3 ] || [ "$DAY_OF_WEEK" -eq 5 ]; then
            echo "üì° MarchesOnline activ√© (mercredi ou vendredi)"
            echo 'urls=["https://www.marchesonline.com/mol/rss/appels-d-offres-domaine-activite-services.xml"]' >> $GITHUB_OUTPUT
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "üì° MarchesOnline d√©sactiv√©"
            echo 'urls=[]' >> $GITHUB_OUTPUT
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üöÄ D√©clencher le workflow AO Veille
        id: trigger
        run: |
          # GitHub Actions = orchestration uniquement :
          # on d√©clenche le workflow Mastra et on v√©rifie le code HTTP.
          # Ne pas stocker de gros JSON dans les outputs (risque de d√©passement m√©moire c√¥t√© expressions GitHub).
          RUN_ID="gh-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          CLIENT_ID="${{ github.event.inputs.clientId }}"
          if [ -z "$CLIENT_ID" ]; then
            CLIENT_ID="${{ secrets.BALTHAZAR_CLIENT_ID }}"
          fi
          
          echo "üîó GitHub Run ID: $RUN_ID"
          echo "üîç Lancement de la veille pour le client: $CLIENT_ID"
          echo "üìÖ Depuis: ${{ steps.date.outputs.since }}"
          echo "üìÖ Jusqu'√†: ${{ steps.date.outputs.until }}"
          echo "üì° MarchesOnline: ${{ steps.marchesonline.outputs.enabled }}"
          
          # Construire le JSON avec until optionnel
          PAYLOAD="{\"inputData\":{\"clientId\":\"$CLIENT_ID\",\"since\":\"${{ steps.date.outputs.since }}\",\"marchesonlineRSSUrls\":${{ steps.marchesonline.outputs.urls }}}}"
          if [ -n "${{ steps.date.outputs.until }}" ]; then
            PAYLOAD=$(echo "$PAYLOAD" | jq --arg u "${{ steps.date.outputs.until }}" '.inputData.until = $u')
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Run-Id: $RUN_ID" \
            -d "$PAYLOAD" \
            ${{ secrets.MASTRA_CLOUD_URL }}/api/workflows/aoVeilleWorkflow/start-async)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          echo "üìä Code HTTP: $HTTP_CODE"
          # Pr√©visualisation tronqu√©e de la r√©ponse pour garder des logs lisibles
          MAX_PREVIEW_CHARS=4000
          BODY_PREVIEW="$BODY"
          if [ ${#BODY_PREVIEW} -gt $MAX_PREVIEW_CHARS ]; then
            BODY_PREVIEW="${BODY_PREVIEW:0:$MAX_PREVIEW_CHARS}...[truncated]"
          fi
          echo "üì¶ R√©ponse (preview): $BODY_PREVIEW"
      
      - name: ‚úÖ V√©rifier le succ√®s
        if: startsWith(steps.trigger.outputs.http_code, '2')
        run: |
          echo "‚úÖ Workflow ex√©cut√© avec succ√®s (code HTTP 2xx)."
          echo "‚ÑπÔ∏è  Voir les logs de l'√©tape 'üöÄ D√©clencher le workflow AO Veille' pour le d√©tail de la r√©ponse Mastra."
      
      - name: ‚ùå G√©rer l'√©chec
        if: !startsWith(steps.trigger.outputs.http_code, '2')
        run: |
          echo "‚ùå Le workflow a √©chou√© avec le code HTTP: ${{ steps.trigger.outputs.http_code }}"
          echo "‚ÑπÔ∏è  Voir les logs de l'√©tape 'üöÄ D√©clencher le workflow AO Veille' pour le d√©tail de la r√©ponse Mastra."
          exit 1
      
      - name: üìß Notifier en cas d'√©chec
        if: failure()
        run: |
          echo "‚ö†Ô∏è ATTENTION: Le workflow AO Veille a √©chou√© !"
          echo "V√©rifiez les logs ci-dessus pour plus de d√©tails."
          # TODO: Ajouter une notification email/Slack ici si n√©cessaire

