name: AO Veille Quotidienne

on:
  schedule:
    # Tous les jours Ã  6h00 UTC (7h Paris hiver, 8h Paris Ã©tÃ©)
    - cron: '0 6 * * *'
  
  # Permet de dÃ©clencher manuellement le workflow pour tester
  workflow_dispatch:
    inputs:
      since:
        description: 'Date de dÃ©but (YYYY-MM-DD) - laissez vide pour hier'
        required: false
        type: string
      clientId:
        description: 'ID du client (laissez vide pour utiliser le dÃ©faut)'
        required: false
        type: string

jobs:
  run-ao-veille:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“… Calculer la date de recherche
        id: date
        run: |
          if [ -n "${{ github.event.inputs.since }}" ]; then
            echo "since=${{ github.event.inputs.since }}" >> $GITHUB_OUTPUT
          else
            echo "since=$(date -d '1 day ago' '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¡ DÃ©terminer activation MarchesOnline
        id: marchesonline
        run: |
          DAY_OF_WEEK=$(date +%u)  # 1=lundi, 3=mercredi, 5=vendredi, 7=dimanche
          
          if [ "$DAY_OF_WEEK" -eq 3 ] || [ "$DAY_OF_WEEK" -eq 5 ]; then
            echo "ğŸ“¡ MarchesOnline activÃ© (mercredi ou vendredi)"
            echo 'urls=["https://www.marchesonline.com/mol/rss/appels-d-offres-domaine-activite-services.xml"]' >> $GITHUB_OUTPUT
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¡ MarchesOnline dÃ©sactivÃ©"
            echo 'urls=[]' >> $GITHUB_OUTPUT
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸš€ DÃ©clencher le workflow AO Veille
        id: trigger
        run: |
          CLIENT_ID="${{ github.event.inputs.clientId }}"
          if [ -z "$CLIENT_ID" ]; then
            CLIENT_ID="${{ secrets.BALTHAZAR_CLIENT_ID }}"
          fi
          
          echo "ğŸ” Lancement de la veille pour le client: $CLIENT_ID"
          echo "ğŸ“… Depuis: ${{ steps.date.outputs.since }}"
          echo "ğŸ“¡ MarchesOnline: ${{ steps.marchesonline.outputs.enabled }}"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"inputData\": {
                \"clientId\": \"$CLIENT_ID\",
                \"since\": \"${{ steps.date.outputs.since }}\",
                \"marchesonlineRSSUrls\": ${{ steps.marchesonline.outputs.urls }}
              }
            }" \
            ${{ secrets.MASTRA_CLOUD_URL }}/api/workflows/aoVeilleWorkflow/start-async)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "response=$BODY" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Code HTTP: $HTTP_CODE"
          echo "ğŸ“¦ RÃ©ponse: $BODY"
      
      - name: âœ… VÃ©rifier le succÃ¨s
        if: steps.trigger.outputs.http_code == '200'
        run: |
          echo "âœ… Workflow exÃ©cutÃ© avec succÃ¨s !"
          echo "ğŸ“Š RÃ©sultat: ${{ steps.trigger.outputs.response }}"
      
      - name: âŒ GÃ©rer l'Ã©chec
        if: steps.trigger.outputs.http_code != '200'
        run: |
          echo "âŒ Le workflow a Ã©chouÃ© avec le code HTTP: ${{ steps.trigger.outputs.http_code }}"
          echo "ğŸ“¦ RÃ©ponse: ${{ steps.trigger.outputs.response }}"
          exit 1
      
      - name: ğŸ“§ Notifier en cas d'Ã©chec
        if: failure()
        run: |
          echo "âš ï¸ ATTENTION: Le workflow AO Veille a Ã©chouÃ© !"
          echo "VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails."
          # TODO: Ajouter une notification email/Slack ici si nÃ©cessaire

